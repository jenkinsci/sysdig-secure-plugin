package com.sysdig.jenkins.plugins.sysdig.application.ui.report;

import static org.junit.jupiter.api.Assertions.assertEquals;

import com.google.gson.JsonElement;
import com.google.gson.JsonParser;
import com.sysdig.jenkins.plugins.sysdig.TestMother;
import com.sysdig.jenkins.plugins.sysdig.application.vm.report.VulnerabilityReportProcessor;
import java.io.IOException;
import org.junit.jupiter.api.Test;

class VulnerabilityReportProcessorTest {

    @Test
    void testPolicyEvaluationSummaryIsGeneratedCorrectly() throws IOException {
        // Given
        var result = TestMother.scanResultForUbuntu2204();
        var imageScanningResult = result.toDomain().get();

        // When
        var vulnerabilityReport = VulnerabilityReportProcessor.generateVulnerabilityReport(imageScanningResult);

        // Then
        // FIXME(fede): the "URL" part should be the rule description, currently it's empty in sysdig-cli-scanner
        // 1.22.3. I expect this will be fixed in newer versions.
        JsonElement expectedJson = JsonParser.parseString(
                """
        {
          "columns":[
            {"title":"Tag"},
            {"title":"CVE ID"},
            {"title":"Severity"},
            {"title":"Vulnerability Package"},
            {"title":"Fix Available"},
            {"title":"URL"},
            {"title":"Package Type"},
            {"title":"Package Path"},
            {"title":"Disclosure Date"},
            {"title":"Solution Date"}
        ],
        "data":[
          ["ubuntu:22.04","CVE-2016-2781","Low","coreutils","None","","OS","/var/lib/dpkg/status","2017-02-07","None"],
          ["ubuntu:22.04","CVE-2022-27943","Low","gcc-12-base","None","","OS","/var/lib/dpkg/status","2022-03-26","None"],
          ["ubuntu:22.04","CVE-2023-4039","Low","gcc-12-base","None","","OS","/var/lib/dpkg/status","2023-09-13","None"],
          ["ubuntu:22.04","CVE-2022-3219","Low","gpgv","None","","OS","/var/lib/dpkg/status","2023-02-23","None"],
          ["ubuntu:22.04","CVE-2016-20013","Negligible","libc-bin","None","","OS","/var/lib/dpkg/status","2022-02-19","None"],
          ["ubuntu:22.04","CVE-2016-20013","Negligible","libc6","None","","OS","/var/lib/dpkg/status","2022-02-19","None"],
          ["ubuntu:22.04","CVE-2022-27943","Low","libgcc-s1","None","","OS","/var/lib/dpkg/status","2022-03-26","None"],
          ["ubuntu:22.04","CVE-2023-4039","Low","libgcc-s1","None","","OS","/var/lib/dpkg/status","2023-09-13","None"],
          ["ubuntu:22.04","CVE-2024-2236","Low","libgcrypt20","None","","OS","/var/lib/dpkg/status","2024-03-06","None"],
          ["ubuntu:22.04","CVE-2025-32990","Medium","libgnutls30","3.7.3-4ubuntu1.7","","OS","/var/lib/dpkg/status","2025-07-10","2025-07-08"],
          ["ubuntu:22.04","CVE-2025-32989","Medium","libgnutls30","3.7.3-4ubuntu1.7","","OS","/var/lib/dpkg/status","2025-07-10","2025-07-08"],
          ["ubuntu:22.04","CVE-2025-6395","Medium","libgnutls30","3.7.3-4ubuntu1.7","","OS","/var/lib/dpkg/status","2025-07-10","2025-07-08"],
          ["ubuntu:22.04","CVE-2025-32988","Medium","libgnutls30","3.7.3-4ubuntu1.7","","OS","/var/lib/dpkg/status","2025-07-10","2025-07-08"],
          ["ubuntu:22.04","CVE-2023-45918","Low","libncurses6","None","","OS","/var/lib/dpkg/status","2024-02-16","None"],
          ["ubuntu:22.04","CVE-2023-50495","Low","libncurses6","None","","OS","/var/lib/dpkg/status","2023-12-12","None"],
          ["ubuntu:22.04","CVE-2023-45918","Low","libncursesw6","None","","OS","/var/lib/dpkg/status","2024-02-16","None"],
          ["ubuntu:22.04","CVE-2023-50495","Low","libncursesw6","None","","OS","/var/lib/dpkg/status","2023-12-12","None"],
          ["ubuntu:22.04","CVE-2025-6020","Medium","libpam-modules","1.4.0-11ubuntu2.6","","OS","/var/lib/dpkg/status","2025-06-17","2025-06-17"],
          ["ubuntu:22.04","CVE-2024-10041","Medium","libpam-modules","None","","OS","/var/lib/dpkg/status","2024-10-23","None"],
          ["ubuntu:22.04","CVE-2025-6020","Medium","libpam-modules-bin","1.4.0-11ubuntu2.6","","OS","/var/lib/dpkg/status","2025-06-17","2025-06-17"],
          ["ubuntu:22.04","CVE-2024-10041","Medium","libpam-modules-bin","None","","OS","/var/lib/dpkg/status","2024-10-23","None"],
          ["ubuntu:22.04","CVE-2025-6020","Medium","libpam-runtime","1.4.0-11ubuntu2.6","","OS","/var/lib/dpkg/status","2025-06-17","2025-06-17"],
          ["ubuntu:22.04","CVE-2024-10041","Medium","libpam-runtime","None","","OS","/var/lib/dpkg/status","2024-10-23","None"],
          ["ubuntu:22.04","CVE-2025-6020","Medium","libpam0g","1.4.0-11ubuntu2.6","","OS","/var/lib/dpkg/status","2025-06-17","2025-06-17"],
          ["ubuntu:22.04","CVE-2024-10041","Medium","libpam0g","None","","OS","/var/lib/dpkg/status","2024-10-23","None"],
          ["ubuntu:22.04","CVE-2022-41409","Low","libpcre2-8-0","None","","OS","/var/lib/dpkg/status","2023-07-18","None"],
          ["ubuntu:22.04","CVE-2017-11164","Negligible","libpcre3","None","","OS","/var/lib/dpkg/status","2017-07-11","None"],
          ["ubuntu:22.04","CVE-2024-41996","Low","libssl3","None","","OS","/var/lib/dpkg/status","2024-08-26","None"],
          ["ubuntu:22.04","CVE-2022-27943","Low","libstdc++6","None","","OS","/var/lib/dpkg/status","2022-03-26","None"],
          ["ubuntu:22.04","CVE-2023-4039","Low","libstdc++6","None","","OS","/var/lib/dpkg/status","2023-09-13","None"],
          ["ubuntu:22.04","CVE-2025-4598","Medium","libsystemd0","249.11-0ubuntu3.16","","OS","/var/lib/dpkg/status","2025-05-30","2025-05-29"],
          ["ubuntu:22.04","CVE-2023-7008","Low","libsystemd0","None","","OS","/var/lib/dpkg/status","2023-12-23","None"],
          ["ubuntu:22.04","CVE-2023-45918","Low","libtinfo6","None","","OS","/var/lib/dpkg/status","2024-02-16","None"],
          ["ubuntu:22.04","CVE-2023-50495","Low","libtinfo6","None","","OS","/var/lib/dpkg/status","2023-12-12","None"],
          ["ubuntu:22.04","CVE-2025-4598","Medium","libudev1","249.11-0ubuntu3.16","","OS","/var/lib/dpkg/status","2025-05-30","2025-05-29"],
          ["ubuntu:22.04","CVE-2023-7008","Low","libudev1","None","","OS","/var/lib/dpkg/status","2023-12-23","None"],
          ["ubuntu:22.04","CVE-2022-4899","Low","libzstd1","None","","OS","/var/lib/dpkg/status","2023-03-31","None"],
          ["ubuntu:22.04","CVE-2023-29383","Low","login","None","","OS","/var/lib/dpkg/status","2023-04-14","None"],
          ["ubuntu:22.04","CVE-2024-56433","Low","login","None","","OS","/var/lib/dpkg/status","2024-12-26","None"],
          ["ubuntu:22.04","CVE-2023-45918","Low","ncurses-base","None","","OS","/var/lib/dpkg/status","2024-02-16","None"],
          ["ubuntu:22.04","CVE-2023-50495","Low","ncurses-base","None","","OS","/var/lib/dpkg/status","2023-12-12","None"],
          ["ubuntu:22.04","CVE-2023-45918","Low","ncurses-bin","None","","OS","/var/lib/dpkg/status","2024-02-16","None"],
          ["ubuntu:22.04","CVE-2023-50495","Low","ncurses-bin","None","","OS","/var/lib/dpkg/status","2023-12-12","None"],
          ["ubuntu:22.04","CVE-2023-29383","Low","passwd","None","","OS","/var/lib/dpkg/status","2023-04-14","None"],
          ["ubuntu:22.04","CVE-2024-56433","Low","passwd","None","","OS","/var/lib/dpkg/status","2024-12-26","None"],
          ["ubuntu:22.04","CVE-2025-45582","Medium","tar","None","","OS","/var/lib/dpkg/status","2025-07-11","None"]
        ]}
      """);
        assertEquals(expectedJson, vulnerabilityReport);
    }
}
